#
# Description: Auto update package
#
name: "Auto update v2"

on:
  push:
    paths:
      - '.github/workflows/Auto update v2.yml'
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:
    inputs:
      packages:
        description: 'packages'
        required: false
        default: 'false'
    
env:
  TZ: Asia/Shanghai

jobs:
  job_init:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: 'main'

      - name: Initialization environment
        run: |
          sudo timedatectl set-timezone "$TZ"

      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@v2.0.6
        continue-on-error: true
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 1
        
      - name: SSH connection to Actions
        uses: mxschmitt/action-tmate@master
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')

  job_auto_update_main:
    if: ${{ always() }}
    needs: job_init
    runs-on: ubuntu-latest
    name: Auto-update-${{ matrix.pakcages }} 
    strategy:
      fail-fast: false
      matrix:
        pakcages: [dns2tcp,ddns-go,dns2socks-rust,docker,dockerd,filebrowser,gost,mosdns,lua-neturl,lucky,redsocks2,smartdns,upx,UnblockNeteaseMusic,brook,hysteria,ipt2socks,microsocks,sing-box,shadowsocksr-libev,trojan,trojan-go,trojan-plus,v2ray-core,v2ray-plugin,xray-core,xray-plugin,v2ray-geoip,v2ray-geosite,geoview]
        include:
          - pakcages: dns2tcp
            folder: dns2tcp
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/zfl9/dns2tcp/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/zfl9/dns2tcp/tar.gz/v
            file_name:

          - pakcages: ddns-go
            folder: ddns-go
            version_line: 11
            hash_line: 16
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/jeessy2/ddns-go/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/jeessy2/ddns-go/tar.gz/v
            file_name:

          - pakcages: dns2socks-rust
            folder: dns2socks-rust
            version_line: 9
            hash_line: 14
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/tun2proxy/dns2socks/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/tun2proxy/dns2socks/tar.gz/v
            file_name:

          - pakcages: docker
            folder: docker
            version_line: 4
            hash_line: 9
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/docker/cli/tags" | grep '"name"' | head -n 1 | awk -F '"' '{print $4}' | sed 's/v//g'
            release_download_url: https://codeload.github.com/docker/cli/tar.gz/v
            file_name:

          - pakcages: dockerd
            folder: dockerd
            version_line: 4
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: 'curl -sL "https://api.github.com/repos/moby/moby/releases/latest" | grep -oP "(?<=tag_name\": \")[^\"]*" | head -1 | sed "s/docker-v//"'
            release_download_url: https://codeload.github.com/moby/moby/tar.gz/docker-v
            file_name:            

          - pakcages: filebrowser
            folder: filebrowser
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/filebrowser/filebrowser/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/filebrowser/filebrowser/tar.gz/v
            file_name:

          - pakcages: gost
            folder: gost
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/go-gost/gost/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/go-gost/gost/tar.gz/v
            file_name: 

          - pakcages: mosdns
            folder: mosdns
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/IrineSistiana/mosdns/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/IrineSistiana/mosdns/tar.gz/v
            file_name: 

          - pakcages: lua-neturl
            folder: lua-neturl
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/golgote/neturl/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/golgote/neturl/tar.gz/v
            file_name: 

          - pakcages: lucky
            folder: lucky
            version_line: 11
            hash_line: 48
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/gdy666/lucky/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/gdy666/lucky/tar.gz/v
            file_name: 

          - pakcages: redsocks2
            folder: redsocks2
            version_line: 9
            hash_line: 14
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/semigodking/redsocks/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'release-' '{print $2}'
            release_download_url: https://codeload.github.com/semigodking/redsocks/tar.gz/release-
            file_name: 

          - pakcages: smartdns
            folder: smartdns
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/pymumu/smartdns/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'Release' '{print $2}'
            release_download_url: https://codeload.github.com/pymumu/smartdns/tar.gz/Release
            file_name:           

          - pakcages: upx
            folder: upx
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/upx/upx/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://github.com/upx/upx/releases/download/v
            file_name: /upx-$New_PKG_VERSION-src.tar.xz         

          - pakcages: UnblockNeteaseMusic
            folder: UnblockNeteaseMusic
            version_line: 4
            hash_line: 9
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/UnblockNeteaseMusic/server/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/UnblockNeteaseMusic/server/tar.gz/v
            file_name: 
    
          - pakcages: brook
            folder: brook
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/txthinking/brook/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/txthinking/brook/tar.gz/v
            file_name:

          - pakcages: hysteria
            folder: hysteria
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/apernet/hysteria/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/apernet/hysteria/tar.gz/app/v
            file_name:

          - pakcages: ipt2socks
            folder: ipt2socks
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/zfl9/ipt2socks/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/zfl9/ipt2socks/tar.gz/v
            file_name:

          - pakcages: microsocks
            folder: microsocks
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/rofl0r/microsocks/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/rofl0r/microsocks/tar.gz/v
            file_name:

          - pakcages: sing-box
            folder: sing-box
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/SagerNet/sing-box/tar.gz/v
            file_name:

          - pakcages: shadowsocksr-libev
            folder: shadowsocksr-libev
            version_line: 4
            hash_line: 9
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/shadowsocksrr/shadowsocksr-libev/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/shadowsocksrr/shadowsocksr-libev/tar.gz/v
            file_name:

          - pakcages: trojan
            folder: trojan
            version_line: 10
            hash_line: 15
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/trojan-gfw/trojan/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/trojan-gfw/trojan/tar.gz/v
            file_name:

          - pakcages: trojan-go
            folder: trojan-go
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/p4gefau1t/trojan-go/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/p4gefau1t/trojan-go/tar.gz/v
            file_name:

          - pakcages: trojan-plus
            folder: trojan-plus
            version_line: 4
            hash_line: 9
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/peter-tank/trojan-plus/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/peter-tank/trojan-plus/tar.gz/v
            file_name:

          - pakcages: v2ray-core
            folder: v2ray-core
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/v2fly/v2ray-core/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/v2fly/v2ray-core/tar.gz/v
            file_name:

          - pakcages: v2ray-plugin
            folder: v2ray-plugin
            version_line: 9
            hash_line: 14
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/teddysun/v2ray-plugin/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/teddysun/v2ray-plugin/tar.gz/v
            file_name:

          - pakcages: xray-core
            folder: xray-core
            version_line: 4
            hash_line: 9
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/XTLS/Xray-core/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/XTLS/Xray-core/tar.gz/v
            file_name:

          - pakcages: xray-plugin
            folder: xray-plugin
            version_line: 8
            hash_line: 13
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/teddysun/xray-plugin/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g' | awk -F 'v' '{print $2}'
            release_download_url: https://codeload.github.com/teddysun/xray-plugin/tar.gz/v
            file_name: 

          - pakcages: v2ray-geoip
            folder: v2ray-geodata
            version_line: 15
            hash_line: 21
            version_head: GEOIP_VER:=
            hash_head: \  HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/v2fly/geoip/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g'
            release_download_url: https://github.com/v2fly/geoip/releases/download/
            file_name: /geoip.dat

          - pakcages: v2ray-geosite
            folder: v2ray-geodata
            version_line: 24
            hash_line: 30
            version_head: GEOSITE_VER:=
            hash_head: \  HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/v2fly/domain-list-community/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g'
            release_download_url: https://github.com/v2fly/domain-list-community/releases/download/
            file_name: /dlc.dat

          - pakcages: v2ray-geosite-ir
            folder: v2ray-geodata
            version_line: 33
            hash_line: 39
            version_head: GEOSITE_IRAN_VER:=
            hash_head: \  HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/bootmortis/iran-hosted-domains/releases" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g'
            release_download_url: https://github.com/bootmortis/iran-hosted-domains/releases/download/
            file_name: /iran.dat

          - pakcages: geoview
            folder: geoview
            version_line: 4
            hash_line: 9
            version_head: PKG_VERSION:=
            hash_head: PKG_HASH:=
            release_api_command: curl -sL "https://api.github.com/repos/snowie2000/geoview/releases/latest" | grep "tag_name" | head -n 1 | awk -F ":" '{print $2}' | sed 's/\"//g;s/,//g;s/ //g'
            release_download_url: https://codeload.github.com/snowie2000/geoview/tar.gz/
            file_name:

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: 'main'

      - name: Initialization environment
        run: |
          sudo timedatectl set-timezone "$TZ"
          mkdir -p ~/main

      - name: Check ${{ matrix.pakcages }}
        id: check
        run: |
          is_continue=true

          if [ "$is_continue" = "true" ]; then
            cd $GITHUB_WORKSPACE/${{ matrix.folder }} 
            Old_PKG_VERSION=$(sed -n '${{ matrix.version_line }}p' Makefile | awk -F '=' '{print $2}')
            New_PKG_VERSION=$(${{ matrix.release_api_command }})
            echo "${{ matrix.pakcages }} 当前版本: $Old_PKG_VERSION"
            echo "${{ matrix.pakcages }} 最新版本: $New_PKG_VERSION"
            if [ "$Old_PKG_VERSION" = "$New_PKG_VERSION" ]; then 
              echo "status=failure" >> $GITHUB_OUTPUT; 
              echo "${{ matrix.pakcages }} 版本为最新版本 $New_PKG_VERSION，无需更新"; 
            else 
              echo "New_PKG_VERSION=$New_PKG_VERSION" >> $GITHUB_OUTPUT;  
              echo "status=success" >> $GITHUB_OUTPUT;
            fi
          else
            echo "status=failure" >> $GITHUB_OUTPUT;
          fi

      - name: Update ${{ matrix.pakcages }}
        id: update
        if: steps.check.outputs.status == 'success' && steps.check.outputs.New_PKG_VERSION != '' && !cancelled()
        run: |
          cd $GITHUB_WORKSPACE/${{ matrix.folder }}
          New_PKG_VERSION=${{ steps.check.outputs.New_PKG_VERSION }}
          sed -i "${{ matrix.version_line }}c ${{ matrix.version_head }}$New_PKG_VERSION" Makefile
          
          mkdir -p ~/main/${{ matrix.pakcages }}
          cd ~/main/${{ matrix.pakcages }}
          
          wget -P ./ ${{ matrix.release_download_url }}$New_PKG_VERSION${{ matrix.file_name }}
          
          file_name="${{ matrix.file_name }}"
          is_v=$(echo ${{ matrix.release_download_url }} | awk -F/ '{print $NF}')
          if [ ! -n "${{ matrix.file_name }}" ]; then 
            PKG_HASH=$(sha256sum $is_v$New_PKG_VERSION | awk '{print $1}')
          else 
            PKG_HASH=$(sha256sum ${file_name##*/} | awk '{print $1}')
          fi
          
          cd $GITHUB_WORKSPACE/${{ matrix.folder }}
          sed -i "${{ matrix.hash_line }}c ${{ matrix.hash_head }}$PKG_HASH" Makefile
          
          echo "已更新 ${{ matrix.pakcages }} 版本到: $New_PKG_VERSION"
          echo "${{ matrix.pakcages }} Hash: $PKG_HASH"
          echo "version=$New_PKG_VERSION" >> $GITHUB_OUTPUT

      - name: Commit and Push ${{ matrix.pakcages }} Changes
        if: steps.check.outputs.status == 'success' && steps.check.outputs.New_PKG_VERSION != '' && !cancelled()
        run: |
          cd $GITHUB_WORKSPACE
          
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "检测到 ${{ matrix.pakcages }} 文件变更，准备提交..."
            git add ${{ matrix.folder }}/Makefile
            git commit -m "${{ matrix.pakcages }}: update to ${{ steps.update.outputs.version }}"
            git push origin main
            echo "✅ 已成功提交并推送 ${{ matrix.pakcages }} 更改到版本 ${{ steps.update.outputs.version }}"
          else
            echo "没有检测到 ${{ matrix.pakcages }} 文件变更"
          fi

  job_auto_update_shadowsocks_libev:
    if: ${{ always() }}
    needs: job_init
    runs-on: ubuntu-latest
    name: Auto-update-shadowsocks-libev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: 'main'

      - name: Initialization environment
        run: |
          sudo timedatectl set-timezone "$TZ"
          sudo apt-get update -y
          sudo apt-get install -y zstd

      - name: Check shadowsocks-libev upstream
        id: check_ss_libev
        run: |
          cd "$GITHUB_WORKSPACE/shadowsocks-libev"
          OLD_VER=$(sed -n '/^PKG_VERSION:=/p' Makefile | awk -F '=' '{print $2}')
          OLD_COMMIT=$(sed -n '/^PKG_SOURCE_VERSION:=/p' Makefile | awk -F '=' '{print $2}')

          NEW_TAG=$(curl -fsSL https://api.github.com/repos/shadowsocks/shadowsocks-libev/releases/latest | grep '"tag_name"' | head -n1 | awk -F '"' '{print $4}')
          NEW_VER=${NEW_TAG#v}
          NEW_COMMIT=$(git ls-remote https://github.com/shadowsocks/shadowsocks-libev.git "refs/tags/${NEW_TAG}^{}" | cut -f1)
          [ -z "$NEW_COMMIT" ] && NEW_COMMIT=$(git ls-remote https://github.com/shadowsocks/shadowsocks-libev.git "refs/tags/${NEW_TAG}" | cut -f1)

          ISO_DATE=$(curl -fsSL https://api.github.com/repos/shadowsocks/shadowsocks-libev/commits/$NEW_COMMIT | grep '"date"' | head -n1 | awk -F '"' '{print $4}')
          NEW_DATE=$(date -u -d "$ISO_DATE" +%Y-%-m-%-d)

          echo "当前版本: $OLD_VER ($OLD_COMMIT)"
          echo "最新版本: $NEW_VER ($NEW_COMMIT)"

          if [ "$OLD_VER" = "$NEW_VER" ] && [ "$OLD_COMMIT" = "$NEW_COMMIT" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "无需更新 shadowsocks-libev"
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "new_ver=$NEW_VER" >> $GITHUB_OUTPUT
            echo "new_commit=$NEW_COMMIT" >> $GITHUB_OUTPUT
            echo "new_date=$NEW_DATE" >> $GITHUB_OUTPUT
          fi

      - name: Build mirror hash for shadowsocks-libev
        id: build_hash
        if: steps.check_ss_libev.outputs.status == 'success' && !cancelled()
        run: |
          PKG_NAME=shadowsocks-libev
          NEW_VER=${{ steps.check_ss_libev.outputs.new_ver }}
          NEW_COMMIT=${{ steps.check_ss_libev.outputs.new_commit }}
          NEW_DATE=${{ steps.check_ss_libev.outputs.new_date }}
          SHORT_COMMIT=${NEW_COMMIT:0:8}
          DIR_NAME="${PKG_NAME}-${NEW_VER}~${NEW_DATE}~${SHORT_COMMIT}"

          mkdir -p ~/main/shadowsocks-libev && cd ~/main/shadowsocks-libev
          rm -rf src "$DIR_NAME" "$DIR_NAME.tar.git" "$DIR_NAME.tar.zst"

          git clone https://github.com/shadowsocks/shadowsocks-libev.git src
          cd src
          git checkout "$NEW_COMMIT"
          TAR_TIMESTAMP=$(git log -1 --no-show-signature --format='@%ct')
          cd ..

          (cd src && git config core.abbrev 8 && git archive --format=tar HEAD --output="../$DIR_NAME.tar.git")
          tar --numeric-owner --owner=0 --group=0 --ignore-failed-read -C src -f "$DIR_NAME.tar.git" -r .git .gitmodules 2>/dev/null || true

          rm -rf src
          mkdir "$DIR_NAME"
          tar -C "$DIR_NAME" -xf "$DIR_NAME.tar.git"
          (cd "$DIR_NAME" && git submodule update --init --recursive -- && rm -rf .git .gitmodules) || true

          tar --numeric-owner --owner=0 --group=0 --mode=a-s --sort=name ${TAR_TIMESTAMP:+--mtime="$TAR_TIMESTAMP"} -c "$DIR_NAME" | zstd -T0 --ultra -20 -c > "$DIR_NAME.tar.zst"
          PKG_HASH=$(sha256sum "$DIR_NAME.tar.zst" | awk '{print $1}')

          echo "pkg_hash=$PKG_HASH" >> $GITHUB_OUTPUT

      - name: Update shadowsocks-libev Makefile
        id: update_ss_libev
        if: steps.check_ss_libev.outputs.status == 'success' && !cancelled()
        run: |
          cd "$GITHUB_WORKSPACE/shadowsocks-libev"
          NEW_VER=${{ steps.check_ss_libev.outputs.new_ver }}
          NEW_COMMIT=${{ steps.check_ss_libev.outputs.new_commit }}
          NEW_DATE=${{ steps.check_ss_libev.outputs.new_date }}
          PKG_HASH=${{ steps.build_hash.outputs.pkg_hash }}

          sed -i "/^PKG_VERSION:=/c\PKG_VERSION:=$NEW_VER" Makefile
          sed -i "/^PKG_SOURCE_DATE:=/c\PKG_SOURCE_DATE:=$NEW_DATE" Makefile
          sed -i "/^PKG_SOURCE_VERSION:=/c\PKG_SOURCE_VERSION:=$NEW_COMMIT" Makefile
          sed -i "/^PKG_MIRROR_HASH:=/c\PKG_MIRROR_HASH:=$PKG_HASH" Makefile

          echo "version=$NEW_VER" >> $GITHUB_OUTPUT
          echo "short_commit=${NEW_COMMIT:0:8}" >> $GITHUB_OUTPUT

      - name: Commit and Push shadowsocks-libev Changes
        if: steps.check_ss_libev.outputs.status == 'success' && !cancelled()
        run: |
          cd "$GITHUB_WORKSPACE"
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

          if [ -n "$(git status --porcelain)" ]; then
            git add shadowsocks-libev/Makefile
            git commit -m "shadowsocks-libev: update to ${{ steps.update_ss_libev.outputs.version }} (${{ steps.update_ss_libev.outputs.short_commit }})"
            git push origin main
            echo "✅ 已成功提交并推送 shadowsocks-libev 更新"
          else
            echo "没有检测到 shadowsocks-libev 文件变更"
          fi
