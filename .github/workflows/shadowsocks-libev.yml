name: Test shadowsocks-libev build

on:
  push:
    paths:
      - 'shadowsocks-libev/**'
  workflow_dispatch:
    inputs:
      plugins:
        description: '插件名，默认编译 shadowsocks-libev 全部组件'
        required: false
        default: 'shadowsocks-libev-ss-local shadowsocks-libev-ss-server shadowsocks-libev-ss-redir shadowsocks-libev-ss-tunnel'

jobs:
  build:
    name: build ${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        sdk:
          - 24.10.2
        arch:
          - x86_64
          - aarch64_cortex-a53

    steps:
      - uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@main
        continue-on-error: true
        with:
          retain_days: 2
          keep_minimum_runs: 2

      - name: Build
        uses: kenzok8/gh-action-sdk@hash
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: ${{ github.event.inputs.plugins || 'shadowsocks-libev-ss-local shadowsocks-libev-ss-server shadowsocks-libev-ss-redir shadowsocks-libev-ss-tunnel' }}
          NO_REFRESH_CHECK: true
          IGNORE_ERRORS: false

      - name: Detect built ipk files
        id: detect_ipk
        run: |
          shopt -s nullglob
          files=(bin/packages/${{ matrix.arch }}/packages_ci/*.ipk)
          if [ ${#files[@]} -gt 0 ]; then
            echo "has_ipk=true" >> $GITHUB_OUTPUT
            printf '%s\n' "${files[@]}"
          else
            echo "has_ipk=false" >> $GITHUB_OUTPUT
            echo "No ipk output found"
          fi

      - name: Store packages
        if: steps.detect_ipk.outputs.has_ipk == 'true'
        uses: actions/upload-artifact@main
        with:
          name: shadowsocks-libev-${{ matrix.arch }}-${{ matrix.sdk }}
          path: bin/packages/${{ matrix.arch }}/packages_ci/*.ipk
          retention-days: 7
