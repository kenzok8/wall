name: "gn auto update"
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
      force_rehash:
        description: 'Force recompute hash even if same version'
        required: false
        default: 'false'
  schedule:
    - cron: "0 0 * * 0"
env:
  TZ: Asia/Shanghai

jobs:
  job_auto_update_gn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set timezone & install zstd
        run: |
          sudo timedatectl set-timezone "$TZ"
          sudo apt-get update -y
          sudo apt-get install -y zstd

      - name: Get old version from Makefile
        id: oldver
        run: |
          cd $GITHUB_WORKSPACE/gn
          echo "old_ver=$(sed -n '/^PKG_SOURCE_VERSION:=/p' Makefile | awk -F '=' '{print $2}')" >> $GITHUB_OUTPUT
          echo "old_date=$(sed -n '/^PKG_SOURCE_DATE:=/p' Makefile | awk -F '=' '{print $2}')" >> $GITHUB_OUTPUT
          echo "old_hash=$(sed -n '/^PKG_MIRROR_HASH:=/p' Makefile | awk -F '=' '{print $2}')" >> $GITHUB_OUTPUT

      - name: Get latest gn commit
        id: newver
        run: |
          NEW_VER=$(git ls-remote https://gn.googlesource.com/gn.git refs/heads/main | cut -f1)
          SHORT_VER=${NEW_VER:0:8}
          LONG_VER=${NEW_VER:0:12}
          echo "new_ver=$NEW_VER" >> $GITHUB_OUTPUT
          echo "short_ver=$SHORT_VER" >> $GITHUB_OUTPUT
          echo "long_ver=$LONG_VER" >> $GITHUB_OUTPUT

      - name: Clone and package gn
        id: pack
        run: |
          mkdir -p ~/pack && cd ~/pack
          cat > calc_gn_hash.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          COMMIT="$1"
          SHORT_VER="$2"

          rm -rf gn-source *.tar.git *.tar.zst gn-*~* hash.txt new_date.txt commit_position.txt
          git clone https://gn.googlesource.com/gn.git gn-source
          cd gn-source
          git checkout "$COMMIT"
          NEW_DATE=$(git log -1 --date=format:%Y-%m-%d --format=%cd)
          COMMIT_POSITION=$(git rev-list --count HEAD)
          TAR_TIMESTAMP=$(git log -1 --no-show-signature --format='@%ct')
          cd ..

          DIR_DATE=${NEW_DATE//-/.}
          DIR_NAME="gn-${DIR_DATE}~${SHORT_VER}"
          TAR_NAME="${DIR_NAME}.tar.zst"

          (cd gn-source && git config core.abbrev 8 && git archive --format=tar HEAD --output="../${DIR_NAME}.tar.git")
          tar --ignore-failed-read -C gn-source -f "${DIR_NAME}.tar.git" -r .git .gitmodules 2>/dev/null || true

          rm -rf gn-source
          mkdir "$DIR_NAME"
          tar -C "$DIR_NAME" -xf "${DIR_NAME}.tar.git"
          (cd "$DIR_NAME" && git submodule update --init --recursive -- && rm -rf .git .gitmodules) || true

          tar --numeric-owner --owner=0 --group=0 --mode=a-s --sort=name ${TAR_TIMESTAMP:+--mtime="$TAR_TIMESTAMP"} -c "$DIR_NAME" | zstd -T0 --ultra -20 -c > "$TAR_NAME"
          sha256sum "$TAR_NAME" | awk '{print $1}' > hash.txt
          echo "$NEW_DATE" > new_date.txt
          echo "$COMMIT_POSITION" > commit_position.txt
          EOF
          chmod +x calc_gn_hash.sh

          docker run --rm -v "$HOME/pack:/work" ghcr.io/openwrt/sdk:x86_64-24.10.2 /bin/bash -lc "cd /work && ./calc_gn_hash.sh '${{ steps.newver.outputs.new_ver }}' '${{ steps.newver.outputs.short_ver }}'"

          PKG_HASH=$(cat hash.txt)
          NEW_DATE=$(cat new_date.txt)
          COMMIT_POSITION=$(cat commit_position.txt)
          DIR_DATE=${NEW_DATE//-/.}
          TAR_NAME="gn-${DIR_DATE}~${{ steps.newver.outputs.short_ver }}.tar.zst"

          echo "new_date=$NEW_DATE" >> $GITHUB_OUTPUT
          echo "tar_name=$TAR_NAME" >> $GITHUB_OUTPUT
          echo "pkg_hash=$PKG_HASH" >> $GITHUB_OUTPUT
          echo "commit_position=$COMMIT_POSITION" >> $GITHUB_OUTPUT

      - name: Check if update is needed
        id: need_update
        run: |
          NEED="false"
          REASON=""

          if [ "${{ steps.oldver.outputs.old_ver }}" != "${{ steps.newver.outputs.new_ver }}" ]; then
            NEED="true"
            REASON="new version"
          fi

          if [ "${{ steps.oldver.outputs.old_date }}" != "${{ steps.pack.outputs.new_date }}" ]; then
            NEED="true"
            [ -z "$REASON" ] && REASON="new source date"
          fi

          if [ "${{ steps.oldver.outputs.old_hash }}" != "${{ steps.pack.outputs.pkg_hash }}" ]; then
            NEED="true"
            [ -z "$REASON" ] && REASON="hash changed"
          fi

          if [ "${{ github.event.inputs.force_rehash }}" = "true" ]; then
            NEED="true"
            [ -z "$REASON" ] && REASON="force rehash"
          fi

          echo "need=$NEED" >> $GITHUB_OUTPUT
          echo "reason=${REASON:-no change}" >> $GITHUB_OUTPUT
          echo "Need update: $NEED (${REASON:-no change})"

      - name: Update Makefile
        if: steps.need_update.outputs.need == 'true'
        run: |
          cd $GITHUB_WORKSPACE/gn
          sed -i "/^PKG_SOURCE_VERSION:=/c\PKG_SOURCE_VERSION:=${{ steps.newver.outputs.new_ver }}" Makefile
          sed -i "/^PKG_SOURCE_DATE:=/c\PKG_SOURCE_DATE:=${{ steps.pack.outputs.new_date }}" Makefile
          sed -i "/^PKG_MIRROR_HASH:=/c\PKG_MIRROR_HASH:=${{ steps.pack.outputs.pkg_hash }}" Makefile

      - name: Update last_commit_position.h
        if: steps.need_update.outputs.need == 'true'
        run: |
          COMMIT_POSITION_FILE="$GITHUB_WORKSPACE/gn/src/out/last_commit_position.h"
          if [ -f "$COMMIT_POSITION_FILE" ]; then
            sed -i "6s/#define LAST_COMMIT_POSITION_NUM .*/#define LAST_COMMIT_POSITION_NUM ${{ steps.pack.outputs.commit_position }}/" "$COMMIT_POSITION_FILE"
            sed -i "7s/#define LAST_COMMIT_POSITION .*/#define LAST_COMMIT_POSITION \"${{ steps.pack.outputs.commit_position }} (${{ steps.newver.outputs.long_ver }})\"/" "$COMMIT_POSITION_FILE"
          fi

      - name: Commit and Push gn Changes
        if: steps.need_update.outputs.need == 'true'
        run: |
          cd $GITHUB_WORKSPACE
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add gn/Makefile
          git add gn/src/out/last_commit_position.h || true
          COMMIT_MSG="gn: auto update to ${{ steps.newver.outputs.short_ver }}"
          git commit -m "$COMMIT_MSG"
          git push origin main
          echo "âœ… Successfully committed and pushed gn changes: $COMMIT_MSG"

      - name: Output update log
        if: steps.need_update.outputs.need == 'true'
        run: |
          echo "GN auto updated:"
          echo "Reason: ${{ steps.need_update.outputs.reason }}"
          echo "New version: ${{ steps.newver.outputs.new_ver }}"
          echo "Date: ${{ steps.pack.outputs.new_date }}"
          echo "Hash: ${{ steps.pack.outputs.pkg_hash }}"
          echo "Commit position: ${{ steps.pack.outputs.commit_position }}"
