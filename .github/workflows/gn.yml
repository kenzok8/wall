name: "gn auto update"
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  schedule:
    - cron: "0 0 * * 0"
env:
  TZ: Asia/Shanghai

jobs:
  job_init:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        run: |
          sudo timedatectl set-timezone "$TZ"

      - name: Delete workflow runs
        continue-on-error: true
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 1
        
      - name: SSH connection to Actions
        uses: kenzok78/ssh-action@master
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')

  job_auto_update_gn:
    if: ${{ always() }}
    needs: job_init
    runs-on: ubuntu-latest
    name: update-gn-package
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        run: |
          cd && mkdir -p pack && cd pack
          sudo timedatectl set-timezone "$TZ"

      - name: Check gn version
        id: check
        run: |
          cd $GITHUB_WORKSPACE/gn
          Old_PKG_VERSION=$(sed -n '/^PKG_SOURCE_VERSION:=/p' Makefile | awk -F '=' '{print $2}')
          Old_PKG_DATE=$(sed -n '/^PKG_SOURCE_DATE:=/p' Makefile | awk -F '=' '{print $2}')
          New_PKG_VERSION=$(git ls-remote https://gn.googlesource.com/gn.git refs/heads/main | cut -f1)
          New_PKG_DATE=$(date +%Y-%m-%d)
          
          echo "gnå½“å‰ç‰ˆæœ¬: ${Old_PKG_VERSION:0:8}..."
          echo "gnæœ€æ–°ç‰ˆæœ¬: ${New_PKG_VERSION:0:8}..."
          echo "gnå½“å‰æ—¥æœŸ: $Old_PKG_DATE"
          echo "gnæœ€æ–°æ—¥æœŸ: $New_PKG_DATE"
          
          if [ "$Old_PKG_VERSION" = "$New_PKG_VERSION" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "gnç‰ˆæœ¬ä¸ºæœ€æ–°ç‰ˆæœ¬,æ— éœ€æ›´æ–°"
          else
            echo "New_PKG_VERSION=$New_PKG_VERSION" >> $GITHUB_OUTPUT
            echo "New_PKG_DATE=$New_PKG_DATE" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT
            echo "å‘ç°gnæ–°ç‰ˆæœ¬: ${New_PKG_VERSION:0:8}..."
          fi

      - name: Update gn
        id: update
        if: steps.check.outputs.status == 'success' && steps.check.outputs.New_PKG_VERSION != '' && !cancelled()
        run: |
          cd $GITHUB_WORKSPACE/gn
          New_PKG_VERSION=${{ steps.check.outputs.New_PKG_VERSION }}
          New_PKG_DATE=${{ steps.check.outputs.New_PKG_DATE }}
          
          echo "ğŸš€ æ›´æ–°gnåˆ°ç‰ˆæœ¬: ${New_PKG_VERSION:0:8}..."
          sed -i "/^PKG_SOURCE_VERSION:=/c\PKG_SOURCE_VERSION:=$New_PKG_VERSION" Makefile
          sed -i "/^PKG_SOURCE_DATE:=/c\PKG_SOURCE_DATE:=$New_PKG_DATE" Makefile
          cd ~/pack && mkdir -p gn && cd gn
          echo "ğŸ“¦ æ­£åœ¨å…‹éš†gnä»“åº“..."
          
          # å…‹éš†å®Œæ•´å†å²è®°å½•ä»¥å‡†ç¡®è®¡ç®— commit position
          git clone https://gn.googlesource.com/gn.git gn-source
          cd gn-source
          git checkout $New_PKG_VERSION
          
          # ğŸ¯ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ git rev-list å‡†ç¡®è®¡ç®— commit position
          echo "ğŸ”¢ è®¡ç®— commit position..."
          COMMIT_POSITION=$(git rev-list --count HEAD)
          echo "âœ… Commit Position: $COMMIT_POSITION"

          rm -rf .git
          cd ..
          tar -cJf gn-source.tar.xz gn-source/
          PKG_HASH=$(sha256sum gn-source.tar.xz | awk '{print $1}')
          cd $GITHUB_WORKSPACE/gn
          sed -i "/^PKG_MIRROR_HASH:=/c\PKG_MIRROR_HASH:=$PKG_HASH" Makefile
          
          # ğŸ¯ æ›´æ–° last_commit_position.h æ–‡ä»¶
          COMMIT_POSITION_FILE="gn/src/out/last_commit_position.h"
          echo "ğŸ“ æ›´æ–° commit position æ–‡ä»¶: $COMMIT_POSITION_FILE"
          
          if [ -f "$GITHUB_WORKSPACE/$COMMIT_POSITION_FILE" ]; then
            echo "å½“å‰æ–‡ä»¶å†…å®¹:"
            head -n 10 "$GITHUB_WORKSPACE/$COMMIT_POSITION_FILE"
            
            # æ›´æ–°ç¬¬6è¡Œ LAST_COMMIT_POSITION_NUM
            sed -i "6s/#define LAST_COMMIT_POSITION_NUM .*/#define LAST_COMMIT_POSITION_NUM $COMMIT_POSITION/" "$GITHUB_WORKSPACE/$COMMIT_POSITION_FILE"
            
            # æ›´æ–°ç¬¬7è¡Œ LAST_COMMIT_POSITION 
            SHORT_COMMIT=${New_PKG_VERSION:0:12}
            sed -i "7s/#define LAST_COMMIT_POSITION .*/#define LAST_COMMIT_POSITION \"$COMMIT_POSITION ($SHORT_COMMIT)\"/" "$GITHUB_WORKSPACE/$COMMIT_POSITION_FILE"
            
            echo "æ›´æ–°åæ–‡ä»¶å†…å®¹:"
            head -n 10 "$GITHUB_WORKSPACE/$COMMIT_POSITION_FILE"
            
            # éªŒè¯æ›´æ–°
            if grep -q "LAST_COMMIT_POSITION_NUM $COMMIT_POSITION" "$GITHUB_WORKSPACE/$COMMIT_POSITION_FILE"; then
              echo "âœ… LAST_COMMIT_POSITION_NUM æ›´æ–°æˆåŠŸ: $COMMIT_POSITION"
            else
              echo "âŒ LAST_COMMIT_POSITION_NUM æ›´æ–°å¤±è´¥"
            fi
            
            if grep -q "LAST_COMMIT_POSITION \"$COMMIT_POSITION ($SHORT_COMMIT)\"" "$GITHUB_WORKSPACE/$COMMIT_POSITION_FILE"; then
              echo "âœ… LAST_COMMIT_POSITION æ›´æ–°æˆåŠŸ: $COMMIT_POSITION ($SHORT_COMMIT)"
            else
              echo "âŒ LAST_COMMIT_POSITION æ›´æ–°å¤±è´¥"
            fi
          else
            echo "âš ï¸  è­¦å‘Š: æ–‡ä»¶ä¸å­˜åœ¨: $COMMIT_POSITION_FILE"
            echo "æœç´¢å¯èƒ½çš„ä½ç½®..."
            find "$GITHUB_WORKSPACE" -name "last_commit_position.h" -type f || echo "æœªæ‰¾åˆ°æ–‡ä»¶"
          fi
          
          echo "ğŸ“Š æ›´æ–°æ€»ç»“:"
          echo "- ç‰ˆæœ¬: ${New_PKG_VERSION:0:8}...${New_PKG_VERSION:32}"
          echo "- æ—¥æœŸ: $New_PKG_DATE"
          echo "- Hash: $PKG_HASH"
          echo "- Commit Position: $COMMIT_POSITION"
          echo "âœ… GN æ›´æ–°å®Œæˆ!"
          
          echo "version=$New_PKG_VERSION" >> $GITHUB_OUTPUT
          echo "short_version=${New_PKG_VERSION:0:8}" >> $GITHUB_OUTPUT
          echo "commit_position=$COMMIT_POSITION" >> $GITHUB_OUTPUT

      - name: Commit and Push gn Changes
        if: steps.check.outputs.status == 'success' && steps.check.outputs.New_PKG_VERSION != '' && !cancelled()
        run: |
          cd $GITHUB_WORKSPACE
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“ æ£€æµ‹åˆ°gnæ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            # æ·»åŠ æ‰€æœ‰ç›¸å…³æ–‡ä»¶
            git add gn/Makefile
            git add gn/src/out/last_commit_position.h
            
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            COMMIT_MSG="gn: update to ${{ steps.update.outputs.short_version }} (cr-pos-${{ steps.update.outputs.commit_position }})"
            
            echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
            git commit -m "$COMMIT_MSG"
            git push origin main
            echo "âœ… å·²æˆåŠŸæäº¤å¹¶æ¨é€gnæ›´æ”¹: $COMMIT_MSG"
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°gnæ–‡ä»¶å˜æ›´"
          fi

