name: "gn & other git packages"
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  schedule:
    - cron: "0 */12 * * *"  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
env:
  TZ: Asia/Shanghai

jobs:
  job_init:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        run: |
          sudo timedatectl set-timezone "$TZ"

      - name: Delete workflow runs
        continue-on-error: true
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 1
        
      - name: SSH connection to Actions
        uses: kenzok78/ssh-action@master
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')

  # è‡ªåŠ¨æäº¤æ‰€æœ‰GitåŒ…çš„æ›´æ–°
  job_auto_update_git_packages:
    if: ${{ always() }}
    needs: job_init
    runs-on: ubuntu-latest
    name: update-${{ matrix.packages }} 
    strategy:
      fail-fast: false
      matrix:
        packages: [gn]
        include:
          - packages: gn
            folder: gn
            version_line: 12
            hash_line: 13 
            date_line: 11
            version_head: PKG_SOURCE_VERSION:=
            hash_head: PKG_MIRROR_HASH:=
            date_head: PKG_SOURCE_DATE:=
            git_repo: https://gn.googlesource.com/gn.git
            git_ref: refs/heads/main
            # GN ç‰¹æ®Šé…ç½®
            has_commit_position: true
            commit_position_file: gn/src/out/last_commit_position.h

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        run: |
          cd && mkdir -p pack && cd pack
          sudo timedatectl set-timezone "$TZ"

      - name: Check ${{ matrix.packages }}
        id: check
        run: |
          is_continue=true

          if [ "$is_continue" = "true" ]; then
            cd $GITHUB_WORKSPACE/${{ matrix.folder }}
            
            # è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
            if [ ! -n "${{ matrix.version_line }}" ] ; then
              Old_PKG_VERSION=$(sed -n '/^${{ matrix.version_head }}/p' Makefile | awk -F '=' '{print $2}');
            else
              Old_PKG_VERSION=$(sed -n '${{ matrix.version_line }}p' Makefile | awk -F '=' '{print $2}');
            fi
            
            if [ ! -n "${{ matrix.date_line }}" ] ; then
              Old_PKG_DATE=$(sed -n '/^${{ matrix.date_head }}/p' Makefile | awk -F '=' '{print $2}');
            else
              Old_PKG_DATE=$(sed -n '${{ matrix.date_line }}p' Makefile | awk -F '=' '{print $2}');
            fi
            
            # è·å–æœ€æ–°ç‰ˆæœ¬
            New_PKG_VERSION=$(git ls-remote ${{ matrix.git_repo }} ${{ matrix.git_ref }} | cut -f1)
            New_PKG_DATE=$(date +%Y-%m-%d)
            
            echo "${{ matrix.packages }}å½“å‰ç‰ˆæœ¬: ${Old_PKG_VERSION:0:8}..."
            echo "${{ matrix.packages }}æœ€æ–°ç‰ˆæœ¬: ${New_PKG_VERSION:0:8}..."
            echo "${{ matrix.packages }}å½“å‰æ—¥æœŸ: $Old_PKG_DATE"
            echo "${{ matrix.packages }}æœ€æ–°æ—¥æœŸ: $New_PKG_DATE"
            
            if [ "$Old_PKG_VERSION" = "$New_PKG_VERSION" ]; then 
              echo "status=failure" >> $GITHUB_OUTPUT; 
              echo "${{ matrix.packages }}ç‰ˆæœ¬ä¸ºæœ€æ–°ç‰ˆæœ¬${New_PKG_VERSION:0:8}...,æ— éœ€æ›´æ–°"; 
            else 
              echo "New_PKG_VERSION=$New_PKG_VERSION" >> $GITHUB_OUTPUT;  
              echo "New_PKG_DATE=$New_PKG_DATE" >> $GITHUB_OUTPUT;
              echo "status=success" >> $GITHUB_OUTPUT;
              echo "å‘ç°${{ matrix.packages }}æ–°ç‰ˆæœ¬: ${New_PKG_VERSION:0:8}...";
            fi
          else
            echo "status=failure" >> $GITHUB_OUTPUT;
          fi

      - name: Update ${{ matrix.packages }}
        id: update
        if: steps.check.outputs.status == 'success' && steps.check.outputs.New_PKG_VERSION != '' && !cancelled()
        run: |
          cd $GITHUB_WORKSPACE/${{ matrix.folder }}
          New_PKG_VERSION=${{ steps.check.outputs.New_PKG_VERSION }}
          New_PKG_DATE=${{ steps.check.outputs.New_PKG_DATE }}
          
          echo "æ›´æ–°${{ matrix.packages }}åˆ°ç‰ˆæœ¬: ${New_PKG_VERSION:0:8}..."
          
          # æ›´æ–°ç‰ˆæœ¬å·
          if [ ! -n "${{ matrix.version_line }}" ] ; then
            sed -i "/^${{ matrix.version_head }}/c\${{ matrix.version_head }}$New_PKG_VERSION" Makefile;
          else
            sed -i "${{ matrix.version_line }}c ${{ matrix.version_head }}$New_PKG_VERSION" Makefile;
          fi
          
          # æ›´æ–°æ—¥æœŸ
          if [ ! -n "${{ matrix.date_line }}" ] ; then
            sed -i "/^${{ matrix.date_head }}/c\${{ matrix.date_head }}$New_PKG_DATE" Makefile;
          else
            sed -i "${{ matrix.date_line }}c ${{ matrix.date_head }}$New_PKG_DATE" Makefile;
          fi
          
          # ä¸‹è½½æºç å¹¶è®¡ç®—hash
          cd ~/pack && mkdir -p ${{ matrix.packages }} && cd ${{ matrix.packages }}
          echo "æ­£åœ¨å…‹éš†${{ matrix.packages }}ä»“åº“..."
          git clone --depth 50 ${{ matrix.git_repo }} ${{ matrix.packages }}-source
          cd ${{ matrix.packages }}-source
          
          # æ£€å‡ºæŒ‡å®šcommit
          git fetch --depth 50 origin $New_PKG_VERSION
          git checkout $New_PKG_VERSION
          
          # è·å– commit positionï¼ˆGN ç‰¹æ®Šå¤„ç†ï¼‰
          COMMIT_POSITION=""
          if [ "${{ matrix.has_commit_position }}" = "true" ]; then
            echo "è·å– commit position..."
            # æŸ¥æ‰¾æœ€è¿‘çš„ Cr-Commit-Position
            COMMIT_POSITION=$(git log --max-count=100 --grep="Cr-Commit-Position" | grep -o "Cr-Commit-Position: refs/heads/master@{#[0-9]*}" | head -n 1 | grep -o "[0-9]*" | head -n 1)
            
            if [ -z "$COMMIT_POSITION" ]; then
              # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ git rev-list è®¡ç®—æäº¤æ•°é‡ä½œä¸ºè¿‘ä¼¼å€¼
              COMMIT_POSITION=$(git rev-list --count HEAD)
              echo "æœªæ‰¾åˆ° Cr-Commit-Positionï¼Œä½¿ç”¨æäº¤æ•°é‡: $COMMIT_POSITION"
            else
              echo "æ‰¾åˆ° Cr-Commit-Position: $COMMIT_POSITION"
            fi
          fi
          
          # åˆ é™¤.gitç›®å½•
          rm -rf .git
          
          # æ‰“åŒ…å¹¶è®¡ç®—hash
          cd ..
          tar -cJf ${{ matrix.packages }}-source.tar.xz ${{ matrix.packages }}-source/
          PKG_HASH=$(sha256sum ${{ matrix.packages }}-source.tar.xz | awk '{print $1}')
          
          # æ›´æ–°hashå€¼
          cd $GITHUB_WORKSPACE/${{ matrix.folder }}
          if [ ! -n "${{ matrix.hash_line }}" ] ; then
            sed -i "/^${{ matrix.hash_head }}/c\${{ matrix.hash_head }}$PKG_HASH" Makefile;
          else
            sed -i "${{ matrix.hash_line }}c ${{ matrix.hash_head }}$PKG_HASH" Makefile;
          fi
          
          # æ›´æ–° commit position æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
          if [ "${{ matrix.has_commit_position }}" = "true" ] && [ -n "$COMMIT_POSITION" ]; then
            echo "æ›´æ–° commit position æ–‡ä»¶..."
            COMMIT_POSITION_FILE="${{ matrix.commit_position_file }}"
            
            if [ -f "$GITHUB_WORKSPACE/$COMMIT_POSITION_FILE" ]; then
              # æ›´æ–°ç¬¬6è¡Œ LAST_COMMIT_POSITION_NUM
              sed -i "6s/#define LAST_COMMIT_POSITION_NUM .*/#define LAST_COMMIT_POSITION_NUM $COMMIT_POSITION/" "$GITHUB_WORKSPACE/$COMMIT_POSITION_FILE"
              
              # æ›´æ–°ç¬¬7è¡Œ LAST_COMMIT_POSITION 
              SHORT_COMMIT=${New_PKG_VERSION:0:12}
              sed -i "7s/#define LAST_COMMIT_POSITION .*/#define LAST_COMMIT_POSITION \"$COMMIT_POSITION ($SHORT_COMMIT)\"/" "$GITHUB_WORKSPACE/$COMMIT_POSITION_FILE"
              
              echo "å·²æ›´æ–° commit position: $COMMIT_POSITION ($SHORT_COMMIT)"
            else
              echo "è­¦å‘Š: commit position æ–‡ä»¶ä¸å­˜åœ¨: $COMMIT_POSITION_FILE"
            fi
          fi
          
          echo "ğŸ“Š æ›´æ–°æ€»ç»“:"
          echo "- åŒ…å: ${{ matrix.packages }}"
          echo "- ç‰ˆæœ¬: ${New_PKG_VERSION:0:8}...${New_PKG_VERSION:32}"
          echo "- Hash: $PKG_HASH"
          if [ -n "$COMMIT_POSITION" ]; then
            echo "- Commit Position: $COMMIT_POSITION"
          fi
          echo "âœ… ${{ matrix.packages }} æ›´æ–°å®Œæˆ!"
          
          echo "version=$New_PKG_VERSION" >> $GITHUB_OUTPUT
          echo "short_version=${New_PKG_VERSION:0:8}" >> $GITHUB_OUTPUT
          echo "commit_position=$COMMIT_POSITION" >> $GITHUB_OUTPUT

      - name: Commit and Push ${{ matrix.packages }} Changes
        if: steps.check.outputs.status == 'success' && steps.check.outputs.New_PKG_VERSION != '' && !cancelled()
        run: |
          cd $GITHUB_WORKSPACE
          
          # é…ç½®git
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            echo "æ£€æµ‹åˆ°${{ matrix.packages }}æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            # æ·»åŠ æ‰€æœ‰ç›¸å…³æ–‡ä»¶
            git add ${{ matrix.folder }}/Makefile
            if [ "${{ matrix.has_commit_position }}" = "true" ] && [ -f "${{ matrix.commit_position_file }}" ]; then
              git add ${{ matrix.commit_position_file }}
            fi
            
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            COMMIT_MSG="${{ matrix.packages }}: update to ${{ steps.update.outputs.short_version }}"
            if [ -n "${{ steps.update.outputs.commit_position }}" ]; then
              COMMIT_MSG="$COMMIT_MSG (cr-pos-${{ steps.update.outputs.commit_position }})"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push origin main
            echo "âœ… å·²æˆåŠŸæäº¤å¹¶æ¨é€ ${{ matrix.packages }} æ›´æ”¹: $COMMIT_MSG"
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°${{ matrix.packages }}æ–‡ä»¶å˜æ›´"
          fi
