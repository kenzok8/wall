name: "Auto Update Git-based Packages"
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  schedule:
    - cron: "0 */12 * * *"  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
env:
  TZ: Asia/Shanghai

jobs:
  job_init:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        run: |
          sudo timedatectl set-timezone "$TZ"

      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 1
        
      - name: SSH connection to Actions
        uses: kenzok78/ssh-action@master
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')

  # è‡ªåŠ¨æ›´æ–°åŸºäºGitæºçš„åŒ…
  job_auto_update_git_packages:
    if: ${{ always() }}
    needs: job_init
    runs-on: ubuntu-latest
    name: update-${{ matrix.package }}
    strategy:
      fail-fast: false
      max-parallel: 1  # ä¸²è¡Œæ‰§è¡Œï¼Œé¿å…åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ªMakefile
      matrix:
        package:
          - ssocks
          - pdnsd
          - simple-obfs
        include:
          - package: ssocks
            folder: ssocks
            git_url: https://github.com/tostercx/ssocks.git

          - package: pdnsd
            folder: pdnsd
            git_url: https://github.com/shadowsocks/pdnsd.git

          - package: simple-obfs
            folder: simple-obfs
            git_url: https://github.com/shadowsocks/simple-obfs.git

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        run: |
          mkdir -p ~/pack
          sudo timedatectl set-timezone "$TZ"
          sudo apt-get update
          sudo apt-get install -y git curl

      - name: Check and Update ${{ matrix.package }}
        id: check_update
        run: |
          # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$GITHUB_WORKSPACE/${{ matrix.folder }}" ]; then
            echo "âŒ ç›®å½• $GITHUB_WORKSPACE/${{ matrix.folder }} ä¸å­˜åœ¨"
            echo "UPDATED=false" >> $GITHUB_ENV
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          cd $GITHUB_WORKSPACE/${{ matrix.folder }}
          
          echo "ğŸ“¦ æ­£åœ¨æ£€æŸ¥ ${{ matrix.package }} çš„Makefile..."
          
          # ä½¿ç”¨grepå’Œawké€šè¿‡å˜é‡åè¯»å–å€¼ï¼ˆä¸ä¾èµ–å›ºå®šè¡Œå·ï¼‰
          Old_DATE=$(grep -E '^PKG_SOURCE_DATE' Makefile | head -1 | awk -F ':?=' '{print $2}' | tr -d ' ')
          Old_COMMIT=$(grep -E '^PKG_SOURCE_VERSION' Makefile | head -1 | awk -F ':?=' '{print $2}' | tr -d ' ')
          Old_HASH=$(grep -E '^PKG_MIRROR_HASH' Makefile | head -1 | awk -F ':?=' '{print $2}' | tr -d ' ')
          
          # å¦‚æœæ²¡æœ‰PKG_MIRROR_HASHï¼Œå°è¯•PKG_HASH
          if [ -z "$Old_HASH" ]; then
            Old_HASH=$(grep -E '^PKG_HASH' Makefile | head -1 | awk -F ':?=' '{print $2}' | tr -d ' ')
            HASH_VAR="PKG_HASH"
          else
            HASH_VAR="PKG_MIRROR_HASH"
          fi
          
          echo "ğŸ“‹ ${{ matrix.package }} å½“å‰ä¿¡æ¯:"
          echo "  æ—¥æœŸå˜é‡: PKG_SOURCE_DATE=$Old_DATE"
          echo "  æäº¤å˜é‡: PKG_SOURCE_VERSION=$Old_COMMIT"
          echo "  å“ˆå¸Œå˜é‡: $HASH_VAR=$Old_HASH"
          
          # å…‹éš†ä»“åº“è·å–æœ€æ–°ä¿¡æ¯
          cd ~/pack
          rm -rf ${{ matrix.package }}_check
          echo ""
          echo "ğŸ” å…‹éš†ä»“åº“æ£€æŸ¥æœ€æ–°æäº¤..."
          git clone --depth 50 ${{ matrix.git_url }} ${{ matrix.package }}_check
          cd ${{ matrix.package }}_check
          
          # è·å–æœ€æ–°æäº¤ä¿¡æ¯
          New_COMMIT=$(git rev-parse HEAD)
          New_DATE=$(git log -1 --format=%cd --date=format:%Y-%m-%d)
          
          echo ""
          echo "âœ¨ ${{ matrix.package }} æœ€æ–°ä¿¡æ¯:"
          echo "  æ—¥æœŸ: $New_DATE"
          echo "  æäº¤: $New_COMMIT"
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
          NEED_UPDATE=false
          
          if [ -n "$Old_COMMIT" ] && [ "$Old_COMMIT" != "$New_COMMIT" ]; then
            echo ""
            echo "âœ… æ£€æµ‹åˆ°æ–°æäº¤ï¼Œéœ€è¦æ›´æ–°"
            NEED_UPDATE=true
          elif [ -z "$Old_COMMIT" ]; then
            echo ""
            echo "âš ï¸  Makefileä¸­æœªæ‰¾åˆ°PKG_SOURCE_VERSIONï¼Œä»…é€šè¿‡æ—¥æœŸåˆ¤æ–­"
            if [ "$Old_DATE" != "$New_DATE" ]; then
              echo "âœ… æ—¥æœŸå·²å˜åŒ–ï¼Œéœ€è¦æ›´æ–°"
              NEED_UPDATE=true
            fi
          else
            echo ""
            echo "â„¹ï¸  å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          fi
          
          if [ "$NEED_UPDATE" = "true" ]; then
            echo ""
            echo "âš™ï¸  å¼€å§‹è®¡ç®—æ–°å“ˆå¸Œå€¼..."
            
            # è®¡ç®—æ–°çš„å“ˆå¸Œå€¼
            cd ~/pack
            rm -rf ${{ matrix.package }}_hash
            git clone ${{ matrix.git_url }} ${{ matrix.package }}_hash
            cd ${{ matrix.package }}_hash
            git checkout $New_COMMIT
            
            # åˆ›å»ºtar.gzå¹¶è®¡ç®—å“ˆå¸Œ - ä½¿ç”¨ç»Ÿä¸€çš„æ‰“åŒ…æ ¼å¼
            cd ~/pack
            echo "ğŸ“¦ ä½¿ç”¨ç»Ÿä¸€æ ¼å¼æ‰“åŒ…..."
            tar --sort=name --owner=root:0 --group=root:0 --numeric-owner -czf ${{ matrix.package }}.tar.gz -C ${{ matrix.package }}_hash .
            New_HASH=$(sha256sum ${{ matrix.package }}.tar.gz | awk '{print $1}')
            
            echo "ğŸ” æ–°å“ˆå¸Œå€¼: $New_HASH"
            
            # æ›´æ–°Makefile - ä½¿ç”¨sedçš„å˜é‡ååŒ¹é…è€Œéè¡Œå·
            cd $GITHUB_WORKSPACE/${{ matrix.folder }}
            
            echo ""
            echo "âœï¸  æ›´æ–°Makefile..."
            
            # æ›´æ–°æ—¥æœŸ - åŒ¹é…PKG_SOURCE_DATEè¡Œå¹¶æ›¿æ¢
            if grep -q '^PKG_SOURCE_DATE' Makefile; then
              sed -i "s|^PKG_SOURCE_DATE.*|PKG_SOURCE_DATE:=$New_DATE|" Makefile
              echo "  âœ“ PKG_SOURCE_DATE: $Old_DATE â†’ $New_DATE"
            fi
            
            # æ›´æ–°æäº¤å“ˆå¸Œ - åŒ¹é…PKG_SOURCE_VERSIONè¡Œå¹¶æ›¿æ¢
            if [ -n "$Old_COMMIT" ]; then
              if grep -q '^PKG_SOURCE_VERSION' Makefile; then
                sed -i "s|^PKG_SOURCE_VERSION.*|PKG_SOURCE_VERSION:=$New_COMMIT|" Makefile
                echo "  âœ“ PKG_SOURCE_VERSION: ${Old_COMMIT:0:8} â†’ ${New_COMMIT:0:8}"
              fi
            fi
            
            # æ›´æ–°æ–‡ä»¶å“ˆå¸Œ - æ ¹æ®å®é™…ä½¿ç”¨çš„å˜é‡å
            if [ "$HASH_VAR" = "PKG_MIRROR_HASH" ]; then
              sed -i "s|^PKG_MIRROR_HASH.*|PKG_MIRROR_HASH:=$New_HASH|" Makefile
              echo "  âœ“ PKG_MIRROR_HASH: ${Old_HASH:0:16}... â†’ ${New_HASH:0:16}..."
            else
              sed -i "s|^PKG_HASH.*|PKG_HASH:=$New_HASH|" Makefile
              echo "  âœ“ PKG_HASH: ${Old_HASH:0:16}... â†’ ${New_HASH:0:16}..."
            fi
            
            echo "UPDATED=true" >> $GITHUB_ENV
            echo "NEW_DATE=$New_DATE" >> $GITHUB_ENV
            echo "NEW_COMMIT=${New_COMMIT:0:8}" >> $GITHUB_ENV
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "UPDATED=false" >> $GITHUB_ENV
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push ${{ matrix.package }} Changes
        if: steps.check_update.outputs.updated == 'true'
        run: |
          cd $GITHUB_WORKSPACE
          
          # é…ç½®git
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          # Pull latest changes first to avoid conflicts
          git pull origin main
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“ æ£€æµ‹åˆ° ${{ matrix.package }} æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            git add ${{ matrix.folder }}/Makefile
            git commit -m "${{ matrix.package }}: update to $NEW_DATE ($NEW_COMMIT)"
            
            # Retry push with pull in case of conflicts
            for i in {1..3}; do
              if git push origin main; then
                echo "âœ… å·²æˆåŠŸæäº¤å¹¶æ¨é€ ${{ matrix.package }} æ›´æ”¹"
                break
              else
                echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œå°è¯• $i/3"
                git pull origin main --rebase
                if [ $i -eq 3 ]; then
                  echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²å°è¯•3æ¬¡"
                  exit 1
                fi
              fi
            done
          else
            echo "â„¹ï¸  æ²¡æœ‰æ£€æµ‹åˆ° ${{ matrix.package }} æ–‡ä»¶å˜æ›´"
          fi

      - name: Cleanup
        if: always()
        run: |
          cd ~/pack
          rm -rf ${{ matrix.package }}_check ${{ matrix.package }}_hash ${{ matrix.package }}.tar.gz
